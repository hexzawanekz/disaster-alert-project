const functions = require("firebase-functions");
const admin = require("firebase-admin");
const axios = require("axios");
const moment = require("moment");

admin.initializeApp();
const db = admin.firestore();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Notify
async function sendLineNotification(message, isHighPriority = false) {
  try {
    // ‡∏î‡∏∂‡∏á token ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    let LINE_NOTIFY_TOKEN;

    if (isHighPriority) {
      // ‡πÉ‡∏ä‡πâ token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ token)
      LINE_NOTIFY_TOKEN =
        functions.config().line.emergency_token ||
        functions.config().line.notify_token;
    } else {
      // ‡πÉ‡∏ä‡πâ token ‡∏õ‡∏Å‡∏ï‡∏¥
      LINE_NOTIFY_TOKEN = functions.config().line.notify_token;
    }

    await axios.post(
      "https://notify-api.line.me/api/notify",
      `message=${message}`,
      {
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          Authorization: `Bearer ${LINE_NOTIFY_TOKEN}`,
        },
      }
    );

    console.log(
      `Sent LINE notification successfully (High Priority: ${isHighPriority})`
    );
    return true;
  } catch (error) {
    console.error("Error sending LINE notification:", error);
    return false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ DeepSearch AI
async function analyzeWithDeepSearch(earthquakeData, impactInfo) {
  try {
    console.log("Analyzing earthquake data with DeepSearch AI...");

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    const analysisData = {
      earthquake: {
        id: earthquakeData.id,
        magnitude: earthquakeData.properties.mag,
        location: earthquakeData.properties.place,
        depth: earthquakeData.geometry.coordinates[2],
        time: earthquakeData.properties.time,
        coordinates: [
          earthquakeData.geometry.coordinates[0],
          earthquakeData.geometry.coordinates[1],
        ],
      },
      impactAssessment: impactInfo,
      historicalData: {
        region: "Southeast Asia",
        recentActivity: true, // ‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
      },
    };

    // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö DeepSearch API ‡∏à‡∏£‡∏¥‡∏á
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÅ‡∏•‡πâ‡∏ß
    /*
    const response = await axios.post(
      "https://api.deepsearch.ai/analyze/earthquake",
      analysisData,
      {
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${functions.config().deepsearch.api_key}`
        }
      }
    );
    
    return response.data;
    */

    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
    // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏à‡∏£‡∏¥‡∏á
    const mockAnalysis = simulateDeepSearchAnalysis(analysisData);
    return mockAnalysis;
  } catch (error) {
    console.error("Error analyzing data with DeepSearch:", error);
    // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ API ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
function simulateDeepSearchAnalysis(data) {
  const earthquake = data.earthquake;
  const impactInfo = data.impactAssessment;

  // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  let confidence = 0.85; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 85%

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡πà‡∏≤‡∏á‡πÜ
  // 1. ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ö‡πà‡∏≠‡∏¢
  if (
    earthquake.location.includes("Myanmar") ||
    earthquake.location.includes("Indonesia") ||
    earthquake.location.includes("Philippines")
  ) {
    confidence += 0.05;
  }

  // 2. ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å (> 6.0) ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏™‡∏π‡∏á
  if (earthquake.magnitude > 6.0) {
    confidence += 0.05;
  }

  // 3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
  const severeImpactLocations = impactInfo.filter(
    (loc) =>
      loc.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á" ||
      loc.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å"
  );

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
  if (severeImpactLocations.length > 0) {
    confidence += 0.05;
  }

  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å (< 4.5) ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏Å‡∏• ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏•‡∏á
  if (earthquake.magnitude < 4.5 && impactInfo[0].distanceKm > 300) {
    confidence -= 0.2;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  let additionalContext = "";

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (data.historicalData.recentActivity) {
    additionalContext =
      "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏ì‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏≠‡∏µ‡∏Å";
  }

  // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
  let recommendation;
  if (confidence >= 0.85) {
    recommendation = "‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ";
  } else if (confidence >= 0.6) {
    recommendation =
      "‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á";
  } else {
    recommendation = "‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô";
  }

  return {
    confidence: confidence,
    shouldAlert: confidence >= 0.6, // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 60%
    suggestedAlertLevel: confidence >= 0.85 ? "original" : "downgrade",
    additionalContext: additionalContext,
    recommendation: recommendation,
    technicalDetails: {
      seismicDataQuality: "high",
      uncertaintyFactors: [
        "wave propagation in Southeast Asian subduction zones",
        "depth calculation",
      ],
      analysisMethod: "DeepSearch Earthquake Impact Assessment Model v1.0",
    },
  };
}

// ======== ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß ========
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
exports.checkEarthquakes = functions.pubsub
  .schedule("every 10 minutes") // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
  .onRun(async (context) => {
    try {
      console.log("Checking for earthquakes...");

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
      const startTime = moment().subtract(15, "minutes").toISOString();
      const endTime = moment().toISOString();

      // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û)
      const thaiLat = 13.7563;
      const thaiLon = 100.5018;

      // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û, ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà, ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢, ‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô, ‡∏ï‡∏≤‡∏Å (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß)
      const thaiKeyLocations = [
        { name: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", lat: 13.7563, lon: 100.5018 },
        { name: "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", lat: 18.7883, lon: 98.9853 },
        { name: "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", lat: 19.9105, lon: 99.826 },
        { name: "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", lat: 19.3027, lon: 97.9654 },
        { name: "‡∏ï‡∏≤‡∏Å", lat: 16.8841, lon: 99.1258 },
      ];

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2,500 ‡∏Å‡∏°.)
      const maxRadius = 25; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏Å‡∏°./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
      const p_wave_velocity = 6.5; // ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô P (Primary) ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 6-8 ‡∏Å‡∏°./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      const s_wave_velocity = 3.5; // ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô S (Secondary) ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3-4 ‡∏Å‡∏°./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      const surface_wave_velocity = 2.5; // ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏ú‡∏¥‡∏ß‡∏î‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2-3 ‡∏Å‡∏°./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ USGS API
      const response = await axios.get(
        "https://earthquake.usgs.gov/fdsnws/event/1/query",
        {
          params: {
            format: "geojson",
            starttime: startTime,
            endtime: endTime,
            minmagnitude: 4.0, // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
            orderby: "time",
          },
        }
      );

      const allEarthquakes = response.data.features;
      console.log(`Found ${allEarthquakes.length} total earthquakes worldwide`);

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      const earthquakes = allEarthquakes.filter((eq) => {
        // ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß
        const eqLon = eq.geometry.coordinates[0];
        const eqLat = eq.geometry.coordinates[1];
        const eqDepth = eq.geometry.coordinates[2]; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (‡∏Å‡∏°.)

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢)
        const latDiff = Math.abs(eqLat - thaiLat);
        const lonDiff = Math.abs(eqLon - thaiLon);
        const distance = Math.sqrt(latDiff * latDiff + lonDiff * lonDiff);

        // ‡∏ñ‡πâ‡∏≤‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Ç‡πâ‡∏≤‡∏°
        if (distance > maxRadius) return false;

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 6.0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô
        if (eq.properties.mag >= 6.0) return true;

        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 5.0-5.9 ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 1,000 ‡∏Å‡∏°.
        if (eq.properties.mag >= 5.0 && distance * 111 <= 1000) return true;

        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 4.0-4.9 ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 500 ‡∏Å‡∏°.
        if (eq.properties.mag >= 4.0 && distance * 111 <= 500) return true;

        return false;
      });

      console.log(
        `Found ${earthquakes.length} significant earthquakes that may affect Thailand`
      );

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      const alertsRef = db.collection("sent_alerts");
      const alertsSnapshot = await alertsRef
        .where("type", "==", "earthquake")
        .where(
          "sentAt",
          ">",
          admin.firestore.Timestamp.fromDate(
            moment().subtract(2, "hours").toDate() // ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ã‡πâ‡∏≥ (aftershock)
          )
        )
        .get();

      const sentAlertIds = new Set();
      alertsSnapshot.forEach((doc) => {
        sentAlertIds.add(doc.data().eventId);
      });

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      const newEarthquakes = earthquakes.filter(
        (eq) => !sentAlertIds.has(eq.id)
      );

      // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏´‡∏°‡πà
      for (const eq of newEarthquakes) {
        const magnitude = eq.properties.mag;
        const place = eq.properties.place;
        const time = moment(eq.properties.time).format("YYYY-MM-DD HH:mm:ss");
        const url = eq.properties.url;
        const eqDepth = eq.geometry.coordinates[2]; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (‡∏Å‡∏°.)

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢
        const impactInfo = thaiKeyLocations.map((location) => {
          const eqLon = eq.geometry.coordinates[0];
          const eqLat = eq.geometry.coordinates[1];

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ñ‡∏∂‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
          const latDiff = Math.abs(eqLat - location.lat);
          const lonDiff = Math.abs(eqLon - location.lon);
          const distanceDegrees = Math.sqrt(
            latDiff * latDiff + lonDiff * lonDiff
          );
          const distanceKm = Math.round(distanceDegrees * 111); // 1 ‡∏≠‡∏á‡∏®‡∏≤ ‚âà 111 ‡∏Å‡∏°.

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏à‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
          const p_wave_time = Math.round(distanceKm / p_wave_velocity);
          const s_wave_time = Math.round(distanceKm / s_wave_velocity);
          const surface_wave_time = Math.round(
            distanceKm / surface_wave_velocity
          );

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß
          const p_arrival = moment(eq.properties.time).add(
            p_wave_time,
            "seconds"
          );
          const s_arrival = moment(eq.properties.time).add(
            s_wave_time,
            "seconds"
          );
          const surface_arrival = moment(eq.properties.time).add(
            surface_wave_time,
            "seconds"
          );

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
          const now = moment();
          const p_arrived = now.isAfter(p_arrival);
          const s_arrived = now.isAfter(s_arrival);
          const surface_arrived = now.isAfter(surface_arrival);

          // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
          let expectedIntensity = "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢";

          if (magnitude >= 7.0 && distanceKm < 300) {
            expectedIntensity = "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å";
          } else if (
            (magnitude >= 6.0 && distanceKm < 300) ||
            (magnitude >= 7.0 && distanceKm < 600)
          ) {
            expectedIntensity = "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á";
          } else if (
            (magnitude >= 5.0 && distanceKm < 200) ||
            (magnitude >= 6.0 && distanceKm < 500)
          ) {
            expectedIntensity = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
          }

          return {
            location: location.name,
            distanceKm,
            p_wave_time,
            s_wave_time,
            surface_wave_time,
            p_arrival: p_arrival.format("HH:mm:ss"),
            s_arrival: s_arrival.format("HH:mm:ss"),
            surface_arrival: surface_arrival.format("HH:mm:ss"),
            p_arrived,
            s_arrived,
            surface_arrived,
            expectedIntensity,
          };
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î)
        impactInfo.sort((a, b) => a.distanceKm - b.distanceKm);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const anyAreaStillWaiting = impactInfo.some(
          (area) => !area.surface_arrived
        );

        // ‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        const worstAffectedArea = impactInfo.reduce((worst, current) => {
          const intensityRank = {
            ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢: 1,
            ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á: 2,
            ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: 3,
            ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å: 4,
          };

          if (
            intensityRank[current.expectedIntensity] >
            intensityRank[worst.expectedIntensity]
          ) {
            return current;
          }
          return worst;
        }, impactInfo[0]);

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        let alertLevel = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        let alertEmoji = "‚ÑπÔ∏è";

        if (
          magnitude >= 7.0 ||
          worstAffectedArea.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å"
        ) {
          alertLevel = "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô";
          alertEmoji = "üö®";
        } else if (
          magnitude >= 6.0 ||
          worstAffectedArea.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á"
        ) {
          alertLevel = "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢";
          alertEmoji = "‚ö†Ô∏è";
        } else if (
          magnitude >= 5.0 ||
          worstAffectedArea.expectedIntensity === "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
        ) {
          alertLevel = "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á";
          alertEmoji = "‚ö†Ô∏è";
        }

        // ‡πÉ‡∏ä‡πâ DeepSearch AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        const aiAnalysis = await analyzeWithDeepSearch(eq, impactInfo);

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        let additionalInfo = "";
        if (aiAnalysis) {
          console.log("DeepSearch AI analysis result:", aiAnalysis);

          // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≥ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          if (aiAnalysis.suggestedAlertLevel === "downgrade") {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
            const originalLevel = alertLevel;

            // ‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏á 1 ‡∏£‡∏∞‡∏î‡∏±‡∏ö
            if (alertLevel === "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô") {
              alertLevel = "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢";
              alertEmoji = "‚ö†Ô∏è";
            } else if (alertLevel === "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢") {
              alertLevel = "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á";
              alertEmoji = "‚ö†Ô∏è";
            } else if (alertLevel === "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á") {
              alertLevel = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
              alertEmoji = "‚ÑπÔ∏è";
            }

            additionalInfo = `\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏≠‡∏≤‡∏à‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (${originalLevel} ‚Üí ${alertLevel})`;
          }

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if (aiAnalysis.additionalContext) {
            additionalInfo += `\n${aiAnalysis.additionalContext}`;
          }

          // ‡∏ñ‡πâ‡∏≤ AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
          if (!aiAnalysis.shouldAlert) {
            console.log(
              `Skipping alert for ${magnitude} earthquake at ${place} based on AI analysis`
            );
            continue;
          }
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        const eqLon = eq.geometry.coordinates[0];
        const eqLat = eq.geometry.coordinates[1];
        const latDiff = Math.abs(eqLat - thaiLat);
        const lonDiff = Math.abs(eqLon - thaiLon);
        const distanceDegrees = Math.sqrt(
          latDiff * latDiff + lonDiff * lonDiff
        );
        const distanceKm = Math.round(distanceDegrees * 111); // 1 ‡∏≠‡∏á‡∏®‡∏≤ ‚âà 111 ‡∏Å‡∏°.

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        let message = `
${alertEmoji} ${alertLevel} ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß ${alertEmoji}
‡∏Ç‡∏ô‡∏≤‡∏î: ${magnitude} ‡∏£‡∏¥‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå
‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${place}
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å: ${eqDepth} ‡∏Å‡∏°.
‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏: ${time}
‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø: ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${distanceKm} ‡∏Å‡∏°.
`;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö
        message += "\n‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á:";
        impactInfo.forEach((area) => {
          if (area.surface_arrived) {
            message += `\n- ${area.location}: ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${area.expectedIntensity})`;
          } else {
            // ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
            const timeToSurface = moment(area.surface_arrival, "HH:mm:ss").diff(
              moment(),
              "seconds"
            );
            if (timeToSurface > 0) {
              message += `\n- ${area.location}: ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${timeToSurface} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${area.expectedIntensity})`;
            } else {
              message += `\n- ${area.location}: ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${area.expectedIntensity})`;
            }
          }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        message += "\n\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:";
        if (magnitude >= 6.0) {
          message +=
            "\n- ‡∏´‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏î‡πÉ‡∏ï‡πâ‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏∑‡∏ô‡∏ä‡∏¥‡∏î‡πÄ‡∏™‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á";
          message += "\n- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏ü‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ä‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏°‡∏≤";
          message += "\n- ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡∏ó‡∏±‡∏ö";
        } else {
          message +=
            "\n- ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô";
          message += "\n- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î";
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏≠‡∏á AI (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (additionalInfo) {
          message += additionalInfo;
        }

        message += `\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${url}`;

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
        const isHighPriority =
          magnitude >= 5.5 ||
          worstAffectedArea.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á" ||
          worstAffectedArea.expectedIntensity === "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å";

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Notify
        await sendLineNotification(message, isHighPriority);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        await alertsRef.add({
          eventId: eq.id,
          type: "earthquake",
          magnitude: magnitude,
          location: place,
          depth: eqDepth,
          distanceFromBkk: distanceKm,
          impactInfo: impactInfo,
          aiAnalysis: aiAnalysis || null, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          time: admin.firestore.Timestamp.fromDate(
            new Date(eq.properties.time)
          ),
          sentAt: admin.firestore.FieldValue.serverTimestamp(),
          alertLevel: alertLevel,
          isHighPriority: isHighPriority,
        });

        console.log(
          `Sent ${alertLevel} alert for earthquake: ${magnitude} at ${place} (${distanceKm} km from Bangkok)`
        );
      }

      return null;
    } catch (error) {
      console.error("Error checking earthquakes:", error);
      return null;
    }
  });

// ======== ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° ========
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏à‡∏≤‡∏Å OpenWeatherMap API ‡∏ó‡∏∏‡∏Å 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
exports.checkFloodAlerts = functions.pubsub
  .schedule("every 3 hours")
  .onRun(async (context) => {
    try {
      console.log("Checking for flood alerts...");

      // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ)
      const locationsToMonitor = [
        { name: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", lat: 13.7563, lon: 100.5018 },
        { name: "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", lat: 13.8622, lon: 100.5142 },
        { name: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", lat: 14.0208, lon: 100.5255 },
      ];

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      const alertsRef = db.collection("sent_alerts");
      const alertsSnapshot = await alertsRef
        .where("type", "==", "flood")
        .where(
          "sentAt",
          ">",
          admin.firestore.Timestamp.fromDate(
            moment().subtract(24, "hours").toDate()
          )
        )
        .get();

      const sentAlertLocations = new Set();
      alertsSnapshot.forEach((doc) => {
        sentAlertLocations.add(doc.data().location);
      });

      const OPENWEATHER_API_KEY = functions.config().openweather.api_key;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
      for (const location of locationsToMonitor) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
        if (sentAlertLocations.has(location.name)) {
          console.log(
            `Already sent flood alert for ${location.name} within last 24 hours, skipping.`
          );
          continue;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ OpenWeatherMap API
        const response = await axios.get(
          "https://api.openweathermap.org/data/2.5/onecall",
          {
            params: {
              lat: location.lat,
              lon: location.lon,
              exclude: "current,minutely,daily",
              appid: OPENWEATHER_API_KEY,
            },
          }
        );

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å (‡∏ù‡∏ô‡∏ï‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏°‡∏°. ‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô)
        const hourlyForecast = response.data.hourly.slice(0, 12); // ‡∏î‡∏π‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

        let heavyRainHours = 0;
        let maxRainfall = 0;

        for (const hour of hourlyForecast) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (hour.rain && hour.rain["1h"]) {
            const rainfall = hour.rain["1h"]; // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ù‡∏ô‡πÉ‡∏ô mm
            maxRainfall = Math.max(maxRainfall, rainfall);

            if (rainfall >= 10) {
              heavyRainHours++;
            }
          }
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏°‡∏°. ‡πÉ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        if (heavyRainHours >= 3 || maxRainfall >= 30) {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          const message = `
üåßÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏â‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏ô üåßÔ∏è
‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${location.name}
‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å${heavyRainHours >= 3 ? ` ${heavyRainHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á` : ""}${
            maxRainfall >= 30
              ? ` ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ù‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxRainfall.toFixed(1)} ‡∏°‡∏°.`
              : ""
          }
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏â‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥
        `;

          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Notify
          await sendLineNotification(message);

          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          await alertsRef.add({
            type: "flood",
            location: location.name,
            heavyRainHours: heavyRainHours,
            maxRainfall: maxRainfall,
            sentAt: admin.firestore.FieldValue.serverTimestamp(),
          });

          console.log(
            `Sent flood alert for ${location.name} due to heavy rain forecast`
          );
        }
      }

      return null;
    } catch (error) {
      console.error("Error checking flood alerts:", error);
      return null;
    }
  });

// ======== ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ ========
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ‡∏à‡∏≤‡∏Å GISTDA API ‡∏ó‡∏∏‡∏Å 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
exports.checkFireAlerts = functions.pubsub
  .schedule("every 6 hours")
  .onRun(async (context) => {
    try {
      console.log("Checking for fire alerts...");

      // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ)
      const provincesToMonitor = [
        { code: "10", name: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" },
        { code: "12", name: "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ" },
        { code: "13", name: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ" },
      ];

      // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const today = moment().format("YYYY-MM-DD");

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      const alertsRef = db.collection("sent_alerts");
      const alertsSnapshot = await alertsRef
        .where("type", "==", "fire")
        .where(
          "sentAt",
          ">",
          admin.firestore.Timestamp.fromDate(
            moment().subtract(24, "hours").toDate()
          )
        )
        .get();

      const sentAlertIds = new Set();
      alertsSnapshot.forEach((doc) => {
        sentAlertIds.add(
          `${doc.data().date}_${doc.data().province}_${doc.data().district}`
        );
      });

      const GISTDA_API_KEY = functions.config().gistda.api_key;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      for (const province of provincesToMonitor) {
        try {
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ GISTDA API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ
          const response = await axios.get(
            `https://fire.gistda.or.th/api/hotspot`,
            {
              params: {
                province_code: province.code,
                date: today,
                api_key: GISTDA_API_KEY,
              },
            }
          );

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô (Hotspots)
          const hotspots = response.data.hotspots || [];
          console.log(`Found ${hotspots.length} hotspots in ${province.name}`);

          // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï
          const districtHotspots = {};

          for (const hotspot of hotspots) {
            const district = hotspot.district_name;
            if (!districtHotspots[district]) {
              districtHotspots[district] = [];
            }
            districtHotspots[district].push(hotspot);
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï
          for (const [district, spots] of Object.entries(districtHotspots)) {
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 3 ‡∏à‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            if (spots.length >= 3) {
              // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
              const alertId = `${today}_${province.name}_${district}`;

              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
              if (sentAlertIds.has(alertId)) {
                console.log(
                  `Already sent fire alert for ${district}, ${province.name} today, skipping.`
                );
                continue;
              }

              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
              const affectedArea = spots.length * 0.25; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ 1 ‡∏à‡∏∏‡∏î = 0.25 ‡∏ï‡∏£.‡∏Å‡∏°.

              // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              const message = `
üî• ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ üî•
‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${district} ‡∏à.${province.name}
‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô: ${spots.length} ‡∏à‡∏∏‡∏î
‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${affectedArea.toFixed(2)} ‡∏ï‡∏£.‡∏Å‡∏°.
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ${today}
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
            `;

              // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Notify
              await sendLineNotification(message);

              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
              await alertsRef.add({
                type: "fire",
                date: today,
                province: province.name,
                district: district,
                hotspotCount: spots.length,
                affectedArea: affectedArea,
                sentAt: admin.firestore.FieldValue.serverTimestamp(),
              });

              console.log(
                `Sent fire alert for ${district}, ${province.name} with ${spots.length} hotspots`
              );
            }
          }
        } catch (error) {
          console.error(
            `Error fetching fire data for ${province.name}:`,
            error
          );
          continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        }
      }

      return null;
    } catch (error) {
      console.error("Error checking fire alerts:", error);
      return null;
    }
  });
