# ระบบแจ้งเตือนภัยพิบัติผ่าน LINE

ระบบแจ้งเตือนภัยพิบัติอัตโนมัติที่ใช้ Firebase และ LINE Notify เพื่อส่งการแจ้งเตือนเมื่อเกิดภัยพิบัติต่างๆ เช่น แผ่นดินไหว น้ำท่วม และไฟไหม้ ระบบจะตรวจสอบข้อมูลจาก APIs ที่เชื่อถือได้ และส่งข้อความแจ้งเตือนไปยังผู้ใช้ผ่าน LINE เมื่อพบเหตุการณ์ที่เข้าเงื่อนไข

**หมายเหตุ**: ระบบนี้ได้รับการตั้งค่าให้แจ้งเตือนเฉพาะภัยพิบัติในพื้นที่กรุงเทพมหานคร นนทบุรี และปทุมธานี สำหรับแผ่นดินไหว ระบบจะตรวจสอบในรัศมีกว้างและคำนวณเวลาที่คลื่นแผ่นดินไหวจะเดินทางมาถึงพื้นที่สำคัญของไทย

## คุณสมบัติ

- **แจ้งเตือนแผ่นดินไหวแบบเรียลไทม์**:
  - ตรวจสอบทุก 10 นาทีเพื่อให้ตรวจจับแผ่นดินไหวได้เร็วที่สุด
  - คำนวณเวลาที่คลื่นแผ่นดินไหวจะเดินทางมาถึงพื้นที่สำคัญในประเทศไทย (กรุงเทพฯ, เชียงใหม่, เชียงราย, แม่ฮ่องสอน, ตาก)
  - ประเมินความรุนแรงที่แต่ละพื้นที่จะได้รับผลกระทบ
  - แจ้งเตือนล่วงหน้าก่อนคลื่นแผ่นดินไหวจะมาถึง (หากตรวจพบทัน)
  - มีระดับความรุนแรงของการแจ้งเตือน 4 ระดับ (ข้อมูล, เฝ้าระวัง, เตือนภัย, ฉุกเฉิน)
- **การวิเคราะห์ขั้นสูงด้วย DeepSeek AI**:

  - ใช้ระบบ AI ช่วยวิเคราะห์ข้อมูลแผ่นดินไหวเชิงลึก
  - ลดการแจ้งเตือนที่ผิดพลาด (false alarms) โดยประเมินความน่าเชื่อถือของข้อมูล
  - ปรับระดับการแจ้งเตือนตามผลการวิเคราะห์ของ AI
  - เพิ่มข้อมูลเชิงลึกเกี่ยวกับสถานการณ์ธรณีวิทยาในพื้นที่

- **แจ้งเตือนน้ำท่วมฉับพลัน**: แจ้งเตือนเมื่อมีการพยากรณ์ฝนตกหนักที่อาจเสี่ยงต่อน้ำท่วมในพื้นที่กรุงเทพมหานคร นนทบุรี และปทุมธานี (ข้อมูลจาก OpenWeatherMap)

- **แจ้งเตือนไฟไหม้/จุดความร้อน**: แจ้งเตือนเมื่อตรวจพบจุดความร้อนตั้งแต่ 3 จุดขึ้นไปในเขต/อำเภอของกรุงเทพมหานคร นนทบุรี และปทุมธานี (ข้อมูลจาก GISTDA)

- **ป้องกันการแจ้งเตือนซ้ำ**: ระบบจะจดจำการแจ้งเตือนที่ส่งไปแล้ว เพื่อป้องกันการแจ้งเตือนซ้ำในเหตุการณ์เดียวกัน

- **ระบบแจ้งเตือนฉุกเฉินสำหรับเหตุการณ์ร้ายแรง**: สามารถส่งการแจ้งเตือนในระดับความสำคัญสูงสำหรับภัยพิบัติร้ายแรง

## เริ่มต้นใช้งาน

### สิ่งที่ต้องมี

1. บัญชี Firebase (ฟรี)
2. บัญชี LINE และได้ลงทะเบียน LINE Notify
   - แนะนำให้มี TOKEN สำหรับการแจ้งเตือนปกติ และ TOKEN สำหรับการแจ้งเตือนฉุกเฉิน
3. API Keys สำหรับบริการต่างๆ:
   - OpenWeatherMap API Key (มีแผนฟรี)
   - GISTDA API Key (สำหรับข้อมูลไฟไหม้ในประเทศไทย)

### ขั้นตอนการติดตั้ง

1. **ตั้งค่า LINE Notify**

   - ไปที่ [LINE Notify](https://notify-bot.line.me/)
   - เข้าสู่ระบบและสร้าง Token สำหรับกลุ่มหรือแชทส่วนตัวที่ต้องการให้ส่งการแจ้งเตือน
   - แนะนำให้สร้าง 2 Token:
     - Token สำหรับการแจ้งเตือนทั่วไป
     - Token สำหรับการแจ้งเตือนฉุกเฉิน (แชทหรือกลุ่มที่ต้องการให้แจ้งเตือนเฉพาะเหตุการณ์สำคัญ)
   - บันทึก Token ที่ได้ไว้ใช้ในขั้นตอนต่อไป

2. **สร้างโปรเจค Firebase**

   - สร้างโปรเจคใหม่ที่ [Firebase Console](https://console.firebase.google.com/)
   - เปิดใช้งานบริการ Firestore Database
   - บันทึก Project ID ไว้ใช้ในขั้นตอนต่อไป

3. **ติดตั้ง Firebase CLI**

   ```bash
   npm install -g firebase-tools
   ```

4. **ล็อกอินเข้า Firebase**

   ```bash
   firebase login
   ```

5. **ตั้งค่าโปรเจค**

   - แก้ไขไฟล์ `.firebaserc` โดยเปลี่ยน `YOUR_FIREBASE_PROJECT_ID` เป็น Project ID ของคุณ
   - สร้างไฟล์ `.env` จากไฟล์ `.env.example` และกรอก API keys ของคุณ

6. **ตั้งค่า Firebase Environment Configuration**

   ```bash
   firebase functions:config:set line.notify_token="YOUR_LINE_NOTIFY_TOKEN" line.emergency_token="YOUR_EMERGENCY_LINE_NOTIFY_TOKEN" openweather.api_key="YOUR_OPENWEATHER_API_KEY" gistda.api_key="YOUR_GISTDA_API_KEY"
   ```

7. **ติดตั้ง Dependencies**

   ```bash
   cd functions
   npm install
   ```

8. **Deploy Function ไปยัง Firebase**
   ```bash
   firebase deploy --only functions
   ```

## การปรับแต่ง

คุณสามารถปรับแต่งระบบได้ตามความต้องการโดยแก้ไขไฟล์ `functions/index.js`:

- **พื้นที่ที่ต้องการตรวจสอบแผ่นดินไหว**: แก้ไขข้อมูลในตัวแปร `thaiKeyLocations` หากต้องการเพิ่ม/ลดพื้นที่สำคัญที่จะติดตาม
- **ความเร็วคลื่นแผ่นดินไหว**: ปรับค่า `p_wave_velocity`, `s_wave_velocity`, และ `surface_wave_velocity` ตามข้อมูลทางธรณีวิทยาที่แม่นยำสำหรับภูมิภาคของคุณ
- **ความถี่ในการตรวจสอบ**: ปรับค่า `schedule` ในแต่ละฟังก์ชัน (ค่าเริ่มต้นของแผ่นดินไหวคือทุก 10 นาที)
- **เกณฑ์การแจ้งเตือน**: ปรับค่าต่างๆ เช่น ขนาดแผ่นดินไหว, ปริมาณน้ำฝน, จำนวนจุดความร้อน
- **รูปแบบข้อความแจ้งเตือน**: แก้ไขตัวแปร `message` ในแต่ละประเภทการแจ้งเตือน
- **การปรับแต่ง DeepSeek AI**: สามารถปรับเปลี่ยนเกณฑ์การวิเคราะห์ของ AI โดยแก้ไขในฟังก์ชัน `simulateDeepSeekAnalysis`
  - ปรับค่า confidence threshold สำหรับการส่งการแจ้งเตือน (ค่าเริ่มต้น: 0.6)
  - ปรับค่า confidence threshold สำหรับการตัดสินใจลดระดับความรุนแรงของแจ้งเตือน (ค่าเริ่มต้น: 0.85)

### การตั้งค่าเฉพาะแผ่นดินไหว

ระบบแจ้งเตือนแผ่นดินไหวได้รับการออกแบบให้ตรวจจับแผ่นดินไหวและคำนวณเวลาที่คลื่นจะมาถึงพื้นที่สำคัญในประเทศไทย คุณสามารถปรับแต่งเพิ่มเติมได้:

- **เกณฑ์การแจ้งเตือน**: ปรับเปลี่ยนเงื่อนไขในส่วนการกรองแผ่นดินไหว เช่น ขนาดขั้นต่ำและระยะห่างสูงสุด
- **ระดับความรุนแรง**: ปรับเปลี่ยนเงื่อนไขในการกำหนดระดับความรุนแรงของการแจ้งเตือน (ข้อมูล, เฝ้าระวัง, เตือนภัย, ฉุกเฉิน)
- **ข้อความคำแนะนำ**: ปรับปรุงคำแนะนำสำหรับแต่ละระดับความรุนแรงตามความเหมาะสม

## วิธีการทดสอบ

1. ทดสอบ Functions ในสภาพแวดล้อมท้องถิ่น:

   ```bash
   firebase serve --only functions
   ```

2. เรียกฟังก์ชันผ่าน Firebase Functions Shell:

   ```bash
   firebase functions:shell
   checkEarthquakes()
   checkFloodAlerts()
   checkFireAlerts()
   ```

3. ทดสอบการแจ้งเตือนแผ่นดินไหวด้วยข้อมูลจำลอง:
   - แก้ไขเทมเพลตการคำนวณเวลาที่คลื่นจะมาถึงเพื่อทดสอบการแจ้งเตือนล่วงหน้า
   - หรือใช้ข้อมูลแผ่นดินไหวที่เคยเกิดขึ้นจริงจาก USGS API เพื่อจำลองเหตุการณ์
   - ทดสอบการวิเคราะห์ของระบบ AI โดยปรับค่าต่างๆ ในฟังก์ชัน `simulateDeepSeekAnalysis`

## การดูแลรักษา

1. **ตรวจสอบการทำงาน**:

   ```bash
   firebase functions:log
   ```

2. **อัปเดตโค้ด**:
   หลังจากแก้ไขโค้ด ให้ Deploy อีกครั้ง:

   ```bash
   firebase deploy --only functions
   ```

3. **ติดตามการใช้งาน Firebase**:
   เฝ้าดูการใช้งานทรัพยากรใน Firebase Console เพื่อไม่ให้เกินข้อจำกัดของแผนฟรี

## ข้อจำกัดและข้อควรระวัง

- **ความถูกต้องของการแจ้งเตือน**: แม้ระบบจะพยายามคำนวณเวลาที่คลื่นแผ่นดินไหวจะมาถึง แต่อาจไม่สามารถแจ้งเตือนล่วงหน้าได้ในทุกกรณี โดยเฉพาะเมื่อแผ่นดินไหวเกิดใกล้พื้นที่
- **ความถี่ในการตรวจสอบ**: การเพิ่มความถี่ในการตรวจสอบ (เช่น ทุก 5 นาที) อาจช่วยให้ตรวจจับแผ่นดินไหวได้เร็วขึ้น แต่จะเพิ่มการใช้งานทรัพยากรของ Firebase
- **ข้อจำกัดของ API**: บริการ USGS มีการจำกัดจำนวนการเรียกใช้งาน API ในแต่ละวัน
- **ข้อจำกัดของ LINE Notify**: มีการจำกัดจำนวนข้อความที่สามารถส่งได้ต่อวัน
- **การวิเคราะห์ด้วย AI**: ขณะนี้เป็นการจำลองการวิเคราะห์ ในอนาคตควรเชื่อมต่อกับ DeepSeek API จริงหรือ API ปัญญาประดิษฐ์อื่นๆ ที่เชี่ยวชาญด้านธรณีวิทยา

## การตั้งค่า DeepSeek AI API (อนาคต)

เมื่อมีการเชื่อมต่อกับ DeepSeek API หรือบริการ AI อื่นๆ ในอนาคต ให้ทำตามขั้นตอนต่อไปนี้:

1. **ลงทะเบียนเพื่อรับ API Key**

   - สมัครใช้งาน DeepSeek หรือบริการ AI ที่ต้องการใช้
   - บันทึก API Key ที่ได้รับ

2. **ตั้งค่า Environment Configuration**

   ```bash
   firebase functions:config:set deepseek.api_key="YOUR_DEEPSEEK_API_KEY"
   ```

3. **แก้ไขฟังก์ชัน `analyzeWithDeepSeek`**
   - นำเครื่องหมายความคิดเห็น (comment) ออกจากส่วนที่เตรียมไว้สำหรับเชื่อมต่อกับ API จริง
   - ปรับแต่ง endpoint และรูปแบบข้อมูลตามเอกสารอ้างอิงของ API ที่ใช้
   - ทดสอบการเชื่อมต่อและการวิเคราะห์ข้อมูล

## แหล่งข้อมูลเพิ่มเติม

- [Firebase Cloud Functions](https://firebase.google.com/docs/functions)
- [LINE Notify API](https://notify-bot.line.me/doc/)
- [USGS Earthquake API](https://earthquake.usgs.gov/fdsnws/event/1/)
- [OpenWeatherMap API](https://openweathermap.org/api)
- [GISTDA](https://fire.gistda.or.th/)
- [ข้อมูลกรมอุตุนิยมวิทยา](https://www.tmd.go.th/)
- [ศูนย์เตือนภัยพิบัติแห่งชาติ](http://www.ndwc.go.th/)
- [DeepSeek AI](https://deepseek.ai) (หรือระบบ AI อื่นๆ ที่ใช้ในการวิเคราะห์ข้อมูลธรณีวิทยา)
